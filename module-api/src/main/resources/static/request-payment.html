<!DOCTYPE html>
<html>
<head>
  <title>결제 테스트</title>
  <meta charset="UTF-8">
  <script src="https://js.tosspayments.com/v1/payment"></script>
</head>
<body>
<h1>토스페이먼츠 테스트</h1>
<div id="info">로딩중...</div>
<div>
  <label>주문 ID: <input type="number" id="orderId" value="5"/></label><br/>
  <label>금액: <input type="number" id="amount" value="240000"/></label><br/>
  <button onclick="requestPayment()">결제하기</button>
</div>

<script>
  let clientKey, token, memberId;
  let tossPayments;

  // 페이지 로드 시 설정 가져오기
  async function loadConfig() {
    const response = await fetch('/api/test/payment-config');
    const config = await response.json();

    clientKey = config.clientKey;
    memberId = config.memberId;

    tossPayments = TossPayments(clientKey);

    document.getElementById('info').innerHTML =
        `회원ID: ${memberId}<br/>Client Key: ${clientKey}`;
  }

  loadConfig();

  async function requestPayment() {
    const orderId = document.getElementById('orderId').value;
    const amount = document.getElementById('amount').value;

    // 1. 백엔드에서 paymentOrderId 받기
    const response = await fetch('/api/payments/prepare', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'bypass-jwt-auth': 'whisKey-dev'
      },
      body: JSON.stringify({
        orderId: parseInt(orderId),
        amount: parseInt(amount),
        description: null
      })
    });

    console.log('Status:', response.status);
    console.log('Headers:', response.headers);

    const data = await response.json();
    console.log(data);

    // 2. 토스 결제창 오픈
    tossPayments.requestPayment('카드', {
      amount: data.data.amount,
      orderId: data.data.orderId,
      orderName: data.data.orderName || '테스트 주문',
      successUrl: window.location.origin + '/api/payments/payment-success',
      failUrl: window.location.origin + '/api/payments/payment-fail',
    });
  }
</script>
</body>
</html>